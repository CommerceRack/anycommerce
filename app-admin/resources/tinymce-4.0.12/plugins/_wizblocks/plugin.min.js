/**
 * plugin.js
 *
 * Copyright 2012, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('_wizblocks', function(editor, url) {
	var cssId, wizBlocksMenuItem, enabled;

	// We don't support older browsers like IE6/7 and they don't provide prototypes for DOM objects
	if (!window.NodeList) {
		return;
	}

	function toggleActiveState() {
		var self = this;

		self.active(enabled);

		editor.on('VisualBlocks', function() {
			self.active(editor.dom.hasClass(editor.getBody(), 'mce-_wizblocks'));
		});
	}
//This is the command executed when the menu is enabled/disabled.
	editor.addCommand('wizBlocks', function() {
		var dom = editor.dom, linkElm;

		if (!cssId) {
			cssId = dom.uniqueId();
			linkElm = dom.create('link', {
				id: cssId,
				rel: 'stylesheet',
				href: url + '/css/_wizblocks.css'
				});

			editor.getDoc().getElementsByTagName('head')[0].appendChild(linkElm);
			}

		// Toggle on/off visual blocks while computing previews
		editor.on("PreviewFormats AfterPreviewFormats", function(e) {
			if (enabled) {
				dom.toggleClass(editor.getBody(), 'mce-_wizblocks', e.type == "afterpreviewformats");
				}
			});

		dom.toggleClass(editor.getBody(), 'mce-_wizblocks');
		enabled = editor.dom.hasClass(editor.getBody(), 'mce-_wizblocks');

		if (wizBlocksMenuItem) {
			wizBlocksMenuItem.active(dom.hasClass(editor.getBody(), 'mce-_wizblocks'));
		}

		editor.fire('VisualBlocks');
	});

	editor.addMenuItem('_wizblocks', {
		text: 'Show wizard blocks',
		cmd: 'wizBlocks',
		onPostRender: toggleActiveState,
		selectable: true,
		context: 'view',
		prependToContext: true
	});

	editor.on('init', function() {
		if (editor.settings._wizblocks_default_state) {
			editor.execCommand('wizBlocks', false, null, {skip_focus: true});
		}
	});

	editor.on('remove', function() {
		editor.dom.removeClass(editor.getBody(), 'mce-_wizblocks');
	});
});
